import { Pool } from 'pg';
import { drizzle } from 'drizzle-orm/node-postgres';
import * as schema from "@shared/schema";
import fs from 'fs';
import path from 'path';
import 'dotenv/config';

// Use database URL from environment variables
const databaseUrl = process.env.NEON_DATABASE_URL || process.env.DATABASE_URL;

if (!databaseUrl) {
  throw new Error(
    "DATABASE_URL must be set. This application requires a PostgreSQL database.",
  );
}

// Determine database provider and configure SSL accordingly
let poolConfig: any = {
  connectionString: databaseUrl,
};
let providerName = "PostgreSQL";

if (databaseUrl.includes('neon.tech')) {
  console.log("üîÑ Connecting to Neon PostgreSQL database...");
  providerName = "Neon PostgreSQL";
  poolConfig.ssl = {
    rejectUnauthorized: true  // Neon uses proper SSL certificates
  };
} else if (databaseUrl.includes('aivencloud.com')) {
  console.log("üîÑ Connecting to Aiven PostgreSQL database...");
  providerName = "Aiven PostgreSQL";
  
  // Proper Aiven SSL configuration with CA certificate
  const caCertPath = path.resolve(import.meta.dirname, '..', 'attached_assets', 'ca_aiven.pem');
  const isDevelopment = process.env.NODE_ENV === 'development';
  
  try {
    const caCert = fs.readFileSync(caCertPath).toString();
    console.log("üìÑ CA certificate loaded for Aiven connection");
    
    if (isDevelopment && process.env.DISABLE_DB_TLS_VALIDATION === 'true') {
      console.log("‚ö†Ô∏è WARNING: TLS validation disabled for development only");
      poolConfig.ssl = {
        rejectUnauthorized: false
      };
    } else {
      // Secure configuration for production
      console.log("üîí Using secure TLS configuration with CA certificate");
      poolConfig.ssl = {
        rejectUnauthorized: true,
        ca: caCert,
        minVersion: 'TLSv1.2'
      };
    }
  } catch (error) {
    console.error(`‚ùå Failed to read CA certificate: ${error}`);
    if (isDevelopment) {
      console.log("‚ö†Ô∏è Falling back to insecure SSL for development");
      poolConfig.ssl = { rejectUnauthorized: false };
    } else {
      throw new Error("Production requires valid CA certificate for Aiven connection");
    }
  }
} else {
  console.log("üîÑ Connecting to PostgreSQL database...");
  // Untuk server yang tidak support SSL, jangan set ssl sama sekali
  // poolConfig.ssl = ...  // Jangan di-set
}

console.log(`üîÑ Using ${providerName} database`);

export const pool = new Pool(poolConfig);
export const db = drizzle(pool, { schema });

// Test database connection on startup
try {
  await pool.query('SELECT 1');
  console.log("‚úÖ Database connection verified successfully");
} catch (error) {
  console.error("‚ùå Failed to connect to database:", error);
  process.exit(1);
}